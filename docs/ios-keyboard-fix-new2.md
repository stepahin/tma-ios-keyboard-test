# Решение проблем с клавиатурой iOS в Telegram Mini App

## Описание проблем

### Проблема 1: Сдвиг интерфейса
На устройствах iOS при открытии виртуальной клавиатуры контент приложения сдвигается вверх, а после закрытия клавиатуры не возвращается на свое место. Интерфейс восстанавливает позицию только после легкого касания экрана или взаимодействия с элементами страницы (например, при касании слайдера).

### Проблема 2: Фантомная кликабельная область
Даже после решения проблемы со сдвигом контента, возникает более серьезная проблема - рассинхронизация визуального и интерактивного положения элементов. Например, форма ввода (PromptForm) отображается в одном месте, но кликабельная область остается на несколько десятков пикселей выше. В результате:

- Курсор текстового поля появляется выше, чем видимый текст
- Маркеры выделения текста «висят в воздухе» выше текстового поля
- Кнопки и слайдер реагируют на касания в невидимой области, а не там, где их видно

### Проблема 3: Динамическое изменение высоты элементов
При увеличении размера текстового поля PromptForm необходимо пропорционально уменьшать размер карусели и вертикальной ленты. Это требует создания динамического механизма пересчета высот элементов, учитывающего различные параметры экрана iOS-устройств.

## Внесенные изменения

### 1. Использование Telegram CSS переменных

Важнейшим обновлением в решении проблем с клавиатурой iOS стало использование специальной CSS-переменной `var(--tg-viewport-stable-height)`, которая предоставляется Telegram Mini App API:

```css
/* Использование стабильной высоты вьюпорта от Telegram */
html, body, #root {
  width: 100%;
  height: 100%;
  height: var(--tg-viewport-stable-height, 100vh); /* Используем переменную viewportStableHeight */
  overflow: hidden;
  margin: 0;
  position: fixed; /* Фиксируем позицию, чтобы предотвратить сдвиг */
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}

/* Фиксация главного контейнера приложения */
.app-container {
  width: 100%;
  height: var(--tg-viewport-stable-height, 100vh); /* Используем переменную viewportStableHeight */
  position: fixed; /* Фиксируем позицию контейнера */
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  transform: translateZ(0); /* Ускорение рендеринга */
  -webkit-transform: translateZ(0);
}
```

Эта переменная отражает стабильную высоту вьюпорта, которая не меняется при появлении/исчезновении клавиатуры, что решает основные проблемы сдвига и рассинхронизации элементов.

### 2. Динамическое управление высотой карусели

Для обеспечения правильного изменения высоты карусели при увеличении/уменьшении текстового поля, мы используем динамический расчет высоты в React-компоненте:

```jsx
<div
  className="horizontal-carousel"
  style={{ 
    height: `calc(var(--tg-viewport-stable-height, 100vh) - 56px - ${promptHeight}px - var(--tg-safe-area-inset-top) - var(--tg-safe-area-inset-bottom))`,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    overflow: 'hidden'
  }}
>
  <EmblaCarousel slides={imageSlides} />
</div>
```

Где `promptHeight` - это динамически рассчитываемый размер формы ввода:

```javascript
// Высота одной строки текста + паддинги
const rowHeight = 24; 
// Базовая высота PromptForm (без учета текстового поля)
const basePromptFormHeight = 128;
// Рассчитываем высоту PromptForm с учетом высоты текстового поля
const promptHeight = basePromptFormHeight + textareaRows * rowHeight;
```

### 3. Плавные анимации изменения высоты

Для плавного изменения высоты элементов мы добавили CSS-переходы с оптимизированными параметрами:

```css
/* Анимация для формы ввода */
.prompt-form {
  transition: height 0.05s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Анимация для текстового поля */
.prompt-textarea {
  transition: background-color 0.1s cubic-bezier(0.4, 0, 0.2, 1), height 0.05s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Анимация для карусели */
.horizontal-carousel {
  transition: height 0.1s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Анимация для вертикальной ленты */
.vertical-feed {
  transition: bottom 0.1s cubic-bezier(0.4, 0, 0.2, 1);
}
```

### 4. Учет безопасных зон (Safe Areas)

Telegram Mini App предоставляет информацию о безопасных зонах (отступах), которые необходимо учитывать при позиционировании элементов. Мы используем эти переменные для корректного позиционирования:

```css
/* Отступ для первого элемента в вертикальной ленте */
.vertical-feed .feed-image:first-child {
  margin-top: calc(56px + var(--tg-safe-area-inset-top) + 16px); /* Добавляем 16px отступ */
}

/* Отступ снизу для формы ввода */
.prompt-form {
  padding-bottom: calc(16px + var(--tg-safe-area-inset-bottom));
}
```

### 5. Динамическое позиционирование вертикальной ленты

Вертикальная лента также должна динамически изменять свое положение в зависимости от высоты PromptForm:

```jsx
<div 
  className="vertical-feed" 
  ref={verticalFeedRef}
  style={{
    bottom: `calc(${promptHeight}px + var(--tg-safe-area-inset-bottom))`
  }}
>
  {/* содержимое ленты */}
</div>
```

## Комплексное решение проблем с клавиатурой iOS

Наше решение включает в себя следующие основные компоненты:

1. **Использование CSS-переменной `var(--tg-viewport-stable-height)`** для стабильной высоты экрана.

2. **Динамический расчет высоты контентных блоков** с учетом высоты формы ввода.

3. **Учет безопасных зон экрана** через CSS-переменные `var(--tg-safe-area-inset-*)`.

4. **Плавные анимации изменения высоты** с оптимизированной скоростью (0.05s для PromptForm и 0.1s для карусели и вертикальной ленты).

5. **Фиксация базовых контейнеров** для предотвращения сдвига интерфейса.

## Результаты решения

После внедрения всех вышеперечисленных улучшений мы достигли следующих результатов:

1. **Стабильное положение элементов интерфейса** при появлении/скрытии клавиатуры.

2. **Синхронизированное визуальное и интерактивное положение элементов** - курсор и маркеры выделения текста появляются точно там, где находится текст.

3. **Плавное изменение высоты контентной области** при увеличении/уменьшении текстового поля.

4. **Корректное отображение на устройствах с различными безопасными зонами** (например, с «челкой» или закругленными углами).

### 5. Результат оптимизаций

Внедрение этих оптимизаций значительно улучшило пользовательский опыт на устройствах iOS:

- Исчезло заметное мерцание при открытии/закрытии клавиатуры
- Ускорилось восстановление карусели при скрытии клавиатуры
- Повысилась общая отзывчивость интерфейса
- Плавные переходы между состояниями с клавиатурой и без неё

Эти улучшения, в сочетании с ранее реализованными хаками для фиксации позиционирования, создают стабильный и отзывчивый интерфейс даже на проблемных устройствах iOS.

## Заключение

Использование специальных CSS-переменных Telegram Mini App (`var(--tg-viewport-stable-height)` и `var(--tg-safe-area-inset-*)`) значительно упрощает разработку адаптивных интерфейсов для iOS устройств. Это позволяет избежать множества хаков и обходных путей, которые требовались ранее для решения проблем с клавиатурой iOS. Динамический расчет высоты элементов и плавные анимации обеспечивают приятный пользовательский опыт при взаимодействии с текстовыми полями.

## Детальная таблица компонентов

Для более подробного понимания, какие именно компоненты и в какие моменты требуют оптимизации, смотрите [ios-keyboard-fix-table.md](./ios-keyboard-fix-table.md). В этом файле приведены сводные таблицы, показывающие отдельно для каждого компонента и процесса, какие CSS и JavaScript решения необходимо применить.
